webpackJsonp([71],{"1NNZ":function(e,t){e.exports={render:function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("m-page-edit",{attrs:{"is-loading":e.loadingState}},[i("m-opus-form",{attrs:{usage:"add",url:e.url,width:parseInt(e.width),height:parseInt(e.height),uid:parseInt(e.uid)},on:{loading:e.changeLoadingState}})],1)},staticRenderFns:[]}},BKr8:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=i("M+im"),s=i.n(a);t.default={name:"app",components:{MOpusForm:s.a},data:function(){return{url:this.$route.params.url,width:this.$route.params.width,height:this.$route.params.height,uid:this.$route.params.uid,loadingState:!1}},methods:{changeLoadingState:function(){this.loadingState=!this.loadingState}}}},"M+im":function(e,t,i){i("b1J0");var a=i("VU/8")(i("sNwv"),i("jWep"),null,null);e.exports=a.exports},Ngdy:function(e,t,i){var a=i("VU/8")(i("BKr8"),i("1NNZ"),null,null);e.exports=a.exports},b1J0:function(e,t,i){var a=i("nSUR");"string"==typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);i("rjj0")("262d2e43",a,!0)},jWep:function(e,t){e.exports={render:function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticStyle:{"padding-top":"20px"}},[i("Form",{attrs:{"label-width":60}},[e._l(e.opuses,function(t,a){return i("Row",[i("Col",{attrs:{span:"23"}},[i("Card",{staticClass:"opus"},[e.isEdit?e._e():i("Form-item",{attrs:{"label-width":85,label:"图片",required:""}},[i("m-upload-image",{attrs:{"obj-type":"share_image","default-images":t.defaultOpus,"image-type":"jpg,jpeg"},on:{"on-success":e.syncOpus},nativeOn:{click:function(t){e.markIndex(a)}},model:{value:t.images,callback:function(i){e.$set(t,"images",i)},expression:"formItem.images"}})],1),e._v(" "),e.isEdit||e.routePassUid?e._e():i("Form-item",{attrs:{"label-width":85,label:"发图者",required:""}},[i("MUserPicking",{attrs:{width:400},on:{"user-change":e.handleUserChange},model:{value:t.user,callback:function(i){e.$set(t,"user",i)},expression:"formItem.user"}})],1),e._v(" "),!e.isEdit&&e.routePassUid?i("Form-item",{attrs:{"label-width":85,label:"发图者",required:""}},[i("i-input",{staticStyle:{width:"400px"},attrs:{placeholder:"发图者",readonly:"",disabled:""},model:{value:e.routePassUsername,callback:function(t){e.routePassUsername=t},expression:"routePassUsername"}})],1):e._e(),e._v(" "),i("Form-item",{attrs:{"label-width":85,label:"美图标签"}},[i("Select",{staticStyle:{width:"400px"},attrs:{filterable:"",multiple:""},model:{value:t.opusTags,callback:function(i){e.$set(t,"opusTags",i)},expression:"formItem.opusTags"}},e._l(e.opusTags,function(t){return i("Option-group",{attrs:{label:t.name}},e._l(t.tags,function(t){return i("Option",{key:t.value,attrs:{value:t.label}},[e._v(e._s(t.label)+"\n                        ")])}))}))],1),e._v(" "),i("Form-item",{class:{hidden:!e.isEdit},attrs:{"label-width":85,label:"教程标签"}},[i("Select",{staticStyle:{width:"400px"},attrs:{filterable:"",multiple:""},model:{value:t.courseTags,callback:function(i){e.$set(t,"courseTags",i)},expression:"formItem.courseTags"}},e._l(e.courseTags,function(t){return i("Option-group",{attrs:{label:t.name}},e._l(t.tags,function(t){return i("Option",{key:t.value,attrs:{value:t.label}},[e._v(e._s(t.label)+"\n                        ")])}))}))],1),e._v(" "),i("Form-item",{attrs:{"label-width":85,label:"评分",required:""}},[i("Button-group",e._l(e.grades,function(s){return i("Button",{attrs:{type:s.grade==t.grade?"primary":"default"},on:{click:function(t){e.setGrade(s.grade,a)}}},[e._v(e._s(s.gradeName)+"\n                    ")])}))],1),e._v(" "),e.isEdit?e._e():i("Form-item",{attrs:{"label-width":85,label:"评分时间",required:""}},[i("Radio-group",{attrs:{id:"rateTimeRadioGroup"},on:{"on-change":e.updateDefaultShowTime},model:{value:t.gradeTimeType,callback:function(i){e.$set(t,"gradeTimeType",i)},expression:"formItem.gradeTimeType"}},[i("Radio",{attrs:{label:"default"}},[i("span",[e._v("默认时间")])]),e._v(" "),i("Radio",{attrs:{label:"custom"}},[i("span",[e._v("自定义时间")])])],1)],1),e._v(" "),e.isEdit||"default"!=t.gradeTimeType?e._e():i("Form-item",{attrs:{label:"时间选择","label-width":85}},[i("Date-picker",{staticStyle:{width:"300px"},attrs:{type:"datetime",placeholder:"选择日期和时间",disabled:""},model:{value:t.defaultGradeTime,callback:function(i){e.$set(t,"defaultGradeTime",i)},expression:"formItem.defaultGradeTime"}})],1),e._v(" "),!e.isEdit&&"custom"==t.gradeTimeType||e.isEdit?i("Form-item",{attrs:{"label-width":85,label:e.isEdit?"评分时间":"时间选择",required:!!e.isEdit}},[i("Date-picker",{staticStyle:{width:"300px"},attrs:{type:"datetime",placeholder:"选择日期和时间"},on:{"on-change":e.syncCustomGradeTime},model:{value:t.customGradeTime,callback:function(i){e.$set(t,"customGradeTime",i)},expression:"formItem.customGradeTime"}})],1):e._e(),e._v(" "),i("Form-item",{attrs:{"label-width":85,label:"标题"}},[i("i-input",{staticStyle:{width:"400px"},attrs:{maxlength:10,placeholder:"10字内"},model:{value:t.title,callback:function(i){e.$set(t,"title",i)},expression:"formItem.title"}})],1),e._v(" "),i("Form-item",{attrs:{"label-width":85,label:"描述"}},[i("i-input",{staticStyle:{width:"400px"},attrs:{maxlength:140,type:"textarea",autosize:{minRows:2,maxRows:5},placeholder:"140字内"},model:{value:t.description,callback:function(i){e.$set(t,"description",i)},expression:"formItem.description"}})],1),e._v(" "),e.isEdit?i("Form-item",{attrs:{"label-width":85}},[i("i-button",{attrs:{type:"primary"},on:{click:e.submit}},[e._v("提交")])],1):e._e()],1)],1),e._v(" "),i("Col",{attrs:{span:"1"}},[e.isEdit||e.routePassUid?e._e():i("Button",{on:{click:function(t){e.unsetOpus(a)}}},[e._v("删除")])],1)],1)}),e._v(" "),e.isEdit||e.routePassUid?e._e():i("div",[i("Button",{attrs:{type:"ghost"},on:{click:e.pushOpus}},[e._v("+ 添加图片")])],1),e._v(" "),e.isEdit?e._e():i("div",[i("Button",{staticStyle:{"margin-top":"20px"},attrs:{type:"primary"},on:{click:e.submit}},[e._v("提交")])],1)],2)],1)},staticRenderFns:[]}},nSUR:function(e,t,i){t=e.exports=i(0)(),t.push([e.i,".shade{left:0}.ivu-col{margin:0}#rateTimeRadioGroup .ivu-form-item,#rateTimeRadioGroup .ivu-radio{float:left}#rateTimeRadioGroup .ivu-form-item-label:before{content:''}#rateTimeRadioGroup .ivu-form-item-label{text-align:left}.hidden{display:none}.opus{margin-bottom:20px}.opus .ivu-card-body{background:#f9f9f9}.rightCloseButton{position:absolute;right:10px;top:10px}",""])},sNwv:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a={create:{api:{path:"/boss/community/opus/opus/create"}},createByTopicImage:{api:{path:"/boss/community/opus/opus/create-by-topic-image"}},update:{api:{path:"/boss/community/opus/opus/update"}},find:{api:{path:"/boss/community/opus/opus/find",params:{fields:"{opus_id,grade_time,tags{name},course_tags{name},title,content,grade,cover{s(w:640){url,width,height,origin}}}",id:0}},responseHandle:function(e){var t=[];e.data.tags.map(function(e){t.push(e.name)}),e.data.tags=t;var i=[];return e.data.course_tags.map(function(e){i.push(e.name)}),e.data.courseTags=i,e.data.opus=[{url:e.data.cover.s.origin,width:e.data.cover.s.width,height:e.data.cover.s.height}],e.data.gradeTime=new Date(1e3*e.data.grade_time),e}},resource:{api:{path:"/boss/community/opus/opus/add-page-info",params:{fields:"{}",uid:0}},responseHandle:function(e){var t=[];if(e.data.form.tags.map(function(e){var i=[];e.son.map(function(e){var t={value:e.id,label:e.name};i.push(t)});var a={name:e.name,tags:i};t.push(a)}),void 0!==e.data.form.courseTags){var i=[],a=function(t){var a=e.data.form.courseTags[t],s={name:a.cate_name,tags:[]};for(var o in a.courseTagsOfGroupId){a.courseTagsOfGroupId[o].map(function(e){s.tags.push({label:e.name,value:e.name})})}i.push(s)};for(var s in e.data.form.courseTags)a(s);e.data.form.courseTags=i}return e.data.form.tags=t,e.data.form.lastModifyShowTime=new Date(1e3*parseInt(e.data.form.lastModifyShowTime)),e}},userResource:{api:{path:"/boss/user/specialaccount/account/find-authors-by-type",params:{type:""}}}};t.default={name:"MOpusForm",props:{id:{type:[String,Number],default:""},usage:{type:String,default:"edit"},url:{type:String,default:""},width:{type:Number,default:0},height:{type:Number,default:0},uid:{type:Number,default:0},loadDetail:{type:Boolean,default:!0}},watch:{id:function(e){this.reloadOpus()}},data:function(){return{opuses:[],grades:[{grade:5,gradeName:"精"},{grade:4,gradeName:"优"},{grade:3,gradeName:"良"},{grade:2,gradeName:"中"},{grade:1,gradeName:"差"}],opusTags:[],courseTags:[],lastModifyShowTime:new Date,lastModifyShowTimeAffectedUids:[],operationIndex:0,imagePathFromUrl:"",resourceLoaded:!1,routePassUsername:""}},computed:{isEdit:function(){return"edit"===this.usage},routePassUid:function(){return 0!==parseInt(this.uid)},creatingTopicImage:function(){return this.imagePathFromUrl===this.opuses[0].images[0].url}},methods:{setGrade:function(e,t){this.opuses[t].grade=e},syncOpus:function(e){this.opuses[this.operationIndex].images=e},getOpusTemplate:function(){return{id:0,images:[],defaultOpus:[],grade:5,opusTags:[],courseTags:[],gradeTimeType:"default",defaultGradeTime:null,customGradeTime:null,title:"",description:"",user:0}},pushOpus:function(){if(10===this.opuses.length)return this.$Notice.warning({title:"一次最多上传10张图片",desc:""}),!1;this.opuses.push(this.getOpusTemplate()),this.updateDefaultShowTime()},unsetOpus:function(e){this.opuses.splice(e,1),this.updateDefaultShowTime()},syncCustomGradeTime:function(e){this.formItem.customGradeTime=new Date(e)},updateDefaultShowTime:function(){var e=this,t=this.lastModifyShowTime;this.opuses.map(function(i,a){var s=e.lastModifyShowTimeAffectedUids.indexOf(parseInt(i.user))>=0;"default"===i.gradeTimeType?(i.defaultGradeTime=t,s&&(t=new Date(t.getTime()+18e5))):i.defaultGradeTime=null})},handleUserChange:function(){this.$nextTick(function(){this.updateDefaultShowTime()})},markIndex:function(e){this.operationIndex=e},back:function(){var e=this.creatingTopicImage?"/community/opus/opus/topic":"/community/opus/opus/list";location.hash=e},submit:function(){if(this.validateFormData()){var e=this.getRequestParams(),t=a.create;this.creatingTopicImage&&(t=a.createByTopicImage),"edit"===this.usage&&(t=a.update),this.submitRequest(e,t)}},validateFormData:function(){var e=this,t=!0,i=[];return this.opuses.map(function(a){if("add"===e.usage){if(0===a.images.length)return e.$Notice.warning({title:"图片不能为空",desc:""}),t=!1,!1;if(a.images.map(function(a){return""===a.url?(e.$Notice.warning({title:"图片不能为空",desc:""}),t=!1,!1):i.indexOf(a.url)>=0?(e.$Notice.warning({title:"不能选择同样的图片",desc:""}),t=!1,!1):void i.push(a.url)}),a.user<=0)return e.$Notice.warning({title:"用户不能为空",desc:""}),t=!1,!1;if(!("custom"!==a.gradeTimeType||a.customGradeTime&&a.customGradeTime.getTime))return e.$Notice.warning({title:"请选择自定义时间",desc:""}),t=!1,!1}if(!("edit"!==e.usage||a.customGradeTime&&a.customGradeTime.getTime))return e.$Notice.warning({title:"请选择自定义时间",desc:""}),t=!1,!1}),t},getRequestParams:function(){var e={opuses:[]},t=this;return this.opuses.map(function(i){var a={tags:i.opusTags,grade:i.grade,title:i.title,content:i.description};"add"===t.usage&&(a.uid=i.user,a.image=i.images[0],a.gradeTime="default"===i.gradeTimeType?parseInt(i.defaultGradeTime.getTime()/1e3):parseInt(i.customGradeTime.getTime()/1e3)),"edit"===t.usage&&(a.gradeTime=parseInt(i.customGradeTime.getTime()/1e3),a.courseTags=i.courseTags,a.id=i.id),e.opuses.push(a)}),e},submitRequest:function(e,t){bus.$emit("on-loading");var i=this;this.$Util.api.post(t,e,i).then(function(e){i.$Notice.success({title:"请求成功",desc:""}),"edit"===i.usage&&i.$emit("on-opus-edit-success",i.id),i.back()},function(e){bus.$emit("on-loading"),i.$Notice.warning({title:"请求失败",desc:""})})},loadResource:function(){if(this.resourceLoaded)return this.$nextTick(function(){this.loadOpus()}),!1;if(!this.loadDetail)return!1;bus.$emit("on-loading");var e=this;a.resource.api.params.uid=this.uid,this.$Util.api.get(a.resource,e).then(function(t){bus.$emit("on-loading"),this.lastModifyShowTime=t.data.form.lastModifyShowTime,this.lastModifyShowTimeAffectedUids=t.data.form.lastModifyShowTimeAffectedUids,this.opusTags=t.data.form.tags,this.routePassUsername=t.data.form.user.username,"add"===e.usage&&this.updateDefaultShowTime(),"edit"===e.usage&&(void 0!==t.data.form.courseTags&&(this.courseTags=t.data.form.courseTags),e.$nextTick(function(){e.loadOpus()})),e.resourceLoaded=!0},function(t){bus.$emit("on-loading"),e.$Notice.warning({title:"加载资源失败",desc:""})})},loadOpus:function(){if(!this.loadDetail)return!1;bus.$emit("on-loading");var e=this;this.$Util.api.get(a.find,e).then(function(e){bus.$emit("on-loading"),this.initOpus({id:e.data.opus_id,opus:e.data.opus,tags:e.data.tags,courseTags:e.data.courseTags,title:e.data.title,content:e.data.content,grade:e.data.grade,customGradeTime:e.data.gradeTime})},function(t){bus.$emit("on-loading"),e.$Notice.warning({title:"加载opus详情失败",desc:""})})},initIds:function(){if("edit"===this.usage){var e=this.id;if(!parseInt(e)&&0!=e)return alert("opusid格式有误"),!1;e=parseInt(e),a.find.api.params.id=e}},initOpus:function(e){var t=this.getOpusTemplate();void 0===e&&(e={}),void 0!==e.opus&&(t.images=e.opus,t.defaultOpus=e.opus),void 0!==e.customGradeTime&&(t.customGradeTime=e.customGradeTime),void 0!==e.title&&(t.title=e.title),void 0!==e.content&&(t.description=e.content),void 0!==e.grade&&(t.grade=e.grade),void 0!==e.tags&&(t.opusTags=e.tags),void 0!==e.courseTags&&(t.courseTags=e.courseTags),void 0!==e.id&&(t.id=e.id),this.opuses.push(t)},initOpusFromUrl:function(){this.opuses[0].images.push({url:this.url,width:this.width,height:this.height}),this.opuses[0].defaultOpus.push({url:this.url,width:this.width,height:this.height})},reloadOpus:function(){this.initIds(),this.opuses=[],this.$nextTick(function(){this.loadResource()})},doEdit:function(){this.initIds(),a.resource.api.path="/boss/community/opus/opus/edit-page-info",this.opuses=[],this.$nextTick(function(){this.loadResource()})}},created:function(){"add"===this.usage&&(this.initOpus(),0!=this.url&&(this.initOpusFromUrl(),this.imagePathFromUrl=this.url),0!=this.uid&&(this.opuses[0].user=this.uid),this.$nextTick(function(){this.loadResource()})),"edit"===this.usage&&this.doEdit()}}}});