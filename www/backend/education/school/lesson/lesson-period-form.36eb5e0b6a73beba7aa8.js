webpackJsonp([140],{"68ut":function(t,e){t.exports={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticStyle:{"font-size":"18px",margin:"3px 0"}},[t._v(t._s(t.info.title))]),t._v(" "),t._l(t.info.subTitles,function(e){return i("div",[t._v(t._s(e))])}),t._v(" "),t.info.assignment?i("div",{staticStyle:{"font-size":"18px",margin:"3px 0"}},[t._v("作业")]):t._e(),t._v(" "),t.info.assignment?i("div",[t._v(t._s(t.info.assignment))]):t._e(),t._v(" "),""!==t.info.assignment&&0!==t.info.image.length?i("div",[i("m-upload-image",{attrs:{"default-images":t.info.image},on:{"on-success":t.syncImages}})],1):t._e(),t._v(" "),i("div",[t._t("extraButton")],2),t._v(" "),i("div",[i("i-button",{on:{click:t.showModal}},[t._v("编辑\n        ")])],1),t._v(" "),i("Modal",{attrs:{title:""},model:{value:t.modalShow,callback:function(e){t.modalShow=e},expression:"modalShow"}},[i("p",[t._v(t._s(t.info.day))]),t._v(" "),i("Form",{attrs:{"label-width":140}},[i("Form-item",{attrs:{label:"当天教学主内容(大标题)",required:""}},[i("i-input",{staticStyle:{width:"200px"},model:{value:t.info.title,callback:function(e){t.$set(t.info,"title",e)},expression:"info.title"}})],1),t._v(" "),t._l(t.info.subTitles,function(e,s){return i("Form-item",{attrs:{label:"小标题"+(s+1)}},[i("i-input",{staticStyle:{width:"200px"},model:{value:t.info.subTitles[s],callback:function(e){t.$set(t.info.subTitles,s,e)},expression:"info.subTitles[key]"}}),t._v(" "),i("i-button",{staticStyle:{color:"red"},attrs:{type:"text"},on:{click:function(e){t.deleteSubTitleByIndex(s)}}},[t._v("删除\n                ")])],1)}),t._v(" "),i("Form-item",{attrs:{label:""}},[i("i-button",{staticStyle:{color:"#39f"},attrs:{type:"ghost"},on:{click:t.addSubTitle}},[t._v("+增加小标题\n                ")])],1),t._v(" "),i("Form-item",{attrs:{label:"当天教学作业",required:""}},[i("i-input",{staticStyle:{width:"200px",height:"50px"},attrs:{type:"textarea"},model:{value:t.info.assignment,callback:function(e){t.$set(t.info,"assignment",e)},expression:"info.assignment"}})],1),t._v(" "),i("Form-item",{attrs:{label:"图片示例"}},[i("m-upload-image",{attrs:{"default-images":t.info.image},on:{"on-success":t.syncImages}})],1)],2)],1)],2)},staticRenderFns:[]}},"7sc8":function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=i("ymID"),o=i.n(s);e.default={components:{MUploadImages:o.a},name:"MLessonPeriodInfo",props:{value:{type:Object,default:function(){return{}}},modalInitShow:{type:Boolean,default:!1}},computed:{},data:function(){return{info:{title:"",subTitles:[],day:"",assignment:"",image:[]},modalShow:this.modalInitShow}},methods:{showModal:function(){this.modalShow=!0},addSubTitle:function(){this.info.subTitles.push("")},deleteSubTitleByIndex:function(t){confirm("确认删除小标题:"+this.info.subTitles[t]+"吗?")&&this.info.subTitles.splice(t,1)},checkTitleEmptyAndWarn:function(){""===this.info.title&&this.$Notice.error({title:"大标题不能为空",desc:this.info.day+"的大标题为空"})},checkAssignmentEmptyAndWarn:function(){""===this.info.assignment&&this.$Notice.error({title:"当天教学作业不能为空",desc:this.info.day+"的当天教学作业为空"})},syncImages:function(t){this.info.image=t}},created:function(){this.info=this.value},watch:{value:function(t){this.info=t},modalShow:function(t){!1===this.modalShow&&(this.checkTitleEmptyAndWarn(),this.checkAssignmentEmptyAndWarn())}}}},GD5X:function(t,e,i){var s=i("VU/8")(i("7sc8"),i("68ut"),null,null);t.exports=s.exports},OdAP:function(t,e,i){var s=i("VU/8")(i("S58h"),i("pD0Q"),null,null);t.exports=s.exports},S58h:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=i("GD5X"),o=i.n(s),n={update:{api:{path:"/boss/education/school/lesson/update-period"}},find:{api:{path:"/boss/education/school/lesson/find",params:{fields:"{id,title,days,school{id,name},periods{id,title,subtitle,name,assignment_description,assignment_image{s(w:80,h:80){url,origin,origin_width,origin_height}},survey_questions{title,type,answer_options,is_required}}}",lessonId:0}}}};e.default={components:{MLessonPeriodInfo:o.a},name:"MLessonPeriodForm",props:{},data:function(){return{school:"",schoolId:0,lesson:"",lessonId:this.$route.params.lessonId,lessonDays:0,periods:[],surveyForPeriod:{},dayModalShow:{}}},methods:{addPeriod:function(){if(parseInt(this.periods.length)>=parseInt(this.lessonDays))return this.$Notice.error({title:"课程天数只有"+this.lessonDays+"天",desc:""}),!1;var t="第"+(this.periods.length+1)+"天";this.periods.push({title:"",day:t,subTitles:[],assignment:"",image:[]}),this.dayModalShow[t]=!0},removeSurvey:function(t){this.$delete(this.surveyForPeriod,t)},previewSurvey:function(t){var e=window.location.host,i=e.replace(/(meijialove\.com)|(\.meijialove\.com)|(\.meijiabang\.cn)/,""),s="";"www"===i||""===i?s+="https://m.meijiabang.cn/single-page/survey-question/index.html?lessonId="+this.lessonId+"&periodId="+t:(s+="http://h5.meijiabang.cn/single-page/survey-question/index.html?lessonId="+this.lessonId+"&periodId="+t,s+="&test_host="+i),window.open(s)},beforeUpload:function(){bus.$emit("on-loading")},handleUploadPeriodExcelSucceed:function(t){var e=this.periods,i=[],s=1,o=this;t.data.map(function(t){s<=o.lessonDays&&(t.day="第"+t.day+"天",t.title=t.title,t.subTitles=t.subTitles,s<=e.length&&""!==e[s-1].assignment?(t.assignment=e[s-1].assignment,t.image=[],void 0!==e[s-1].image&&0!==e[s-1].image.length&&(t.image=e[s-1].image)):(t.assignment="",t.image=[])),i.push(t),s++}),this.periods=i,bus.$emit("on-loading"),this.submitAndCallback(function(){o.reload()})},handleUploadAssignmentExcelSucceed:function(t){var e=this.periods,i=[],s=this,o=1;for(t.data.map(function(t){o<=e.length&&("第"+t.day+"天"!==e[o-1].day&&(t.assignment=""),i.push({day:e[o-1].day,title:e[o-1].title,subTitles:e[o-1].subTitles,assignment:t.assignment,image:e[o-1].image})),o++});;){if(!(e.length>o-1))break;i.push({day:e[o-1].day,title:e[o-1].title,subTitles:e[o-1].subTitles,assignment:"",image:[]}),o++}this.periods=i,bus.$emit("on-loading"),this.submitAndCallback(function(){s.reload()})},handleUploadSurveyExcelSucceed:function(t){var e={},i=function(i){var s=t.data[i],o={questions:[]};s.map(function(t){var e={title:t.title,type:t.type,isRequired:t.is_required};1===parseInt(e.type)&&(e.options=t.options),o.questions.push(e)}),e[i]=o};for(var s in t.data)i(s);this.surveyForPeriod=e;var o=this;bus.$emit("on-loading"),this.submitAndCallback(function(){o.reload()})},back:function(){location.hash="/education/school/lesson/list/"+this.schoolId},reload:function(){window.location.reload()},submit:function(){if(this.validateFormData()){var t=this.getRequestParams(),e=this;this.submitRequest(t,function(){e.back()})}},submitAndCallback:function(t){if(this.validateFormData()){var e=this.getRequestParams();this.submitRequest(e,function(){setTimeout(function(){t()},500)})}},validateFormData:function(){var t=!0,e=this;return this.periods.map(function(i){if(t)return""===i.title?(e.$Notice.error({title:"大标题不能为空",desc:i.day+"的大标题为空"}),void(t=!1)):void(""===i.assignment&&(e.$Notice.error({title:"当天教学作业不能为空",desc:i.day+"的当天教学作业为空"}),t=!1))}),t},getRequestParams:function(){var t=this,e=[],i={};return this.periods.map(function(s){e.push({title:s.title,day:s.day,subTitle:s.subTitles,assignment:s.assignment,image:s.image}),void 0!==t.surveyForPeriod[s.day]&&(i[s.day]=t.surveyForPeriod[s.day])}),{lessonId:this.lessonId,periods:e,surveyForPeriod:i}},submitRequest:function(t,e){bus.$emit("on-loading");var i=this,s=n.update;this.$Util.api.post(s,t,i).then(function(t){i.$Notice.success({title:"请求成功",desc:""}),e()},function(t){bus.$emit("on-loading"),i.$Notice.error({title:"请求失败",desc:""})})},loadLesson:function(){bus.$emit("on-loading");var t=this;this.$Util.api.get(n.find,t).then(function(e){bus.$emit("on-loading"),t.schoolId=e.data.school.id,t.school=e.data.school.name,t.lesson=e.data.title,t.lessonDays=e.data.days,null!==e.data.periods&&e.data.periods.map(function(e){var i={title:e.title,day:e.name,subTitles:null===e.subtitle?[]:e.subtitle,periodId:e.id,assignment:e.assignment_description,image:[]};if(null!==e.survey_questions){var s=[];e.survey_questions.map(function(t){var e={title:t.title,type:t.type,isRequired:t.is_required?1:0};1===parseInt(e.type)&&(e.options=JSON.stringify(t.answer_options)),s.push(e)}),s.length>0&&(t.surveyForPeriod[i.day]={questions:s})}var o=[];o.push(e.assignment_image),o.map(function(t){null!=t&&0!==t.length&&i.image.push({url:t.s.origin,width:t.s.origin_width,height:t.s.origin_height})}),t.periods.push(i)})},function(){bus.$emit("on-loading"),t.$Message.warning("加载课程详情失败")})},initIds:function(){var t=this.lessonId;if(!parseInt(t))return alert("课程id格式有误"),!1;t=parseInt(t),n.find.api.params.lessonId=t}},created:function(){window.a=this,this.initIds(),this.$nextTick(function(){this.loadLesson()})}}},pD0Q:function(t,e){t.exports={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("MPage",[i("Card",[i("div",{staticStyle:{"padding-top":"20px"}},[i("Form",{attrs:{model:t.formItem,"label-width":100}},[i("Form-item",{attrs:{label:"学校"}},[t._v("\n                    "+t._s(t.school)+"\n\n                ")]),t._v(" "),i("Form-item",{attrs:{label:"课程"}},[t._v("\n                    "+t._s(t.lesson)+"\n\n                ")]),t._v(" "),i("Form-item",{attrs:{label:"课程天数"}},[t._v("\n                    "+t._s(t.lessonDays)+"\n\n                ")]),t._v(" "),t._l(t.periods,function(e,s){return i("Form-item",{attrs:{label:t.periods[s].day}},[i("MLessonPeriodInfo",{staticStyle:{"margin-left":"20px","margin-bottom":"20px"},attrs:{modalInitShow:void 0!==t.dayModalShow[t.periods[s].day]},model:{value:t.periods[s],callback:function(e){t.$set(t.periods,s,e)},expression:"periods[key]"}},[i("div",{attrs:{slot:"extraButton"},slot:"extraButton"},[void 0!==t.surveyForPeriod[t.periods[s].day]?i("div",[void 0!==t.periods[s].periodId?i("i-button",{staticStyle:{color:"#39f","text-decoration":"underline"},attrs:{type:"text"},on:{click:function(e){t.previewSurvey(t.periods[s].periodId)}}},[t._v("查看评价问卷\n                                ")]):t._e(),t._v(" "),i("i-button",{staticStyle:{color:"red","text-decoration":"underline"},attrs:{type:"text"},on:{click:function(e){t.removeSurvey(t.periods[s].day)}}},[t._v("删除当前问卷\n                                ")])],1):t._e()])])],1)}),t._v(" "),t.lessonDays>t.periods.length?i("Form-item",{attrs:{label:""}},[i("i-button",{on:{click:t.addPeriod}},[t._v("+新的一天")])],1):t._e(),t._v(" "),i("Form-item",{attrs:{label:""}},[i("Upload",{staticStyle:{display:"inline-block"},attrs:{action:"/boss/education/school/lesson/convert-period-from-excel",name:"periods","on-success":t.handleUploadPeriodExcelSucceed,"before-upload":t.beforeUpload,"show-upload-list":!1}},[i("Button",{attrs:{type:"ghost",icon:"ios-cloud-upload-outline"}},[t._v("上传每日课程信息")])],1),t._v(" "),t.periods.length>0?i("Upload",{staticStyle:{display:"inline-block"},attrs:{action:"/boss/education/school/lesson/convert-assignment-from-excel",name:"assignment","on-success":t.handleUploadAssignmentExcelSucceed,"before-upload":t.beforeUpload,"show-upload-list":!1}},[i("Button",{attrs:{type:"ghost",icon:"ios-cloud-upload-outline"}},[t._v("上传每日作业")])],1):t._e(),t._v(" "),t.periods.length>0?i("Upload",{staticStyle:{display:"inline-block"},attrs:{action:"/boss/education/school/lesson/convert-survey-from-excel",name:"survey","on-success":t.handleUploadSurveyExcelSucceed,"before-upload":t.beforeUpload,"show-upload-list":!1}},[i("Button",{attrs:{type:"ghost",icon:"ios-cloud-upload-outline"}},[t._v("上传课程评价问卷")])],1):t._e()],1),t._v(" "),i("Form-item",{attrs:{label:""}},[i("a",{attrs:{href:"/static/admin/Static/excel/学校课程课时_tpl.xls"}},[t._v("点击下载每日课程模板文件")]),t._v(" "),i("a",{attrs:{href:"/static/admin/Static/excel/学校课程每日作业_tpl.xls"}},[t._v("点击下载每日作业模板文件")]),t._v(" "),i("a",{attrs:{href:"/static/admin/Static/excel/学校课程课时问卷_tpl.xls"}},[t._v("点击下载课程评价问卷模板文件")])]),t._v(" "),i("Form-item",[i("i-button",{attrs:{type:"primary"},on:{click:t.submit}},[t._v("保存")]),t._v(" "),i("i-button",{staticStyle:{"margin-left":"8px"},attrs:{type:"ghost"},on:{click:t.back}},[t._v("取消")])],1)],2)],1)])],1)},staticRenderFns:[]}}});