webpackJsonp([236],{"0bZq":function(t,i){t.exports={render:function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",[e("m-page-list",{attrs:{path:t.api.path,params:t.api.params,columns:t.columns,methods:t.methods,"response-handle":t.responseHandle,"page-info-path":t.pageInfoApi.path,"page-info-params":t.pageInfoApi.params,"sort-key":"index","sort-index":4,sortable:t.sortable,"sort-path":t.sortInfoApi.path,"sort-params":t.sortInfoApi.params},on:{"on-page-info-success":t.handlePageInfoSuccess}},[e("m-action-bar",[e("Button",{attrs:{type:"primary"},on:{click:t.addCity}},[t._v("新增\n            ")])],1),t._v(" "),e("m-action-bar",{attrs:{slot:"search"},slot:"search"},[e("m-action-search-bar",{attrs:{"search-condition":t.searchCondition,"search-condition-handle":t.searchConditionHandle}},[e("div",{staticStyle:{margin:"20px 0"}},[e("m-form-item",{attrs:{label:"默认推荐城市"}},[e("MRegionSelect",{attrs:{"change-on-select":"",styles:"width:300px",level:2},on:{"on-change":t.handleDefaultCitySelect},model:{value:t.defaultCity,callback:function(i){t.defaultCity=i},expression:"defaultCity"}})],1)],1),t._v(" "),e("div",[e("m-form-item",[e("MRegionSelect",{attrs:{"change-on-select":"",styles:"width:300px",level:1},model:{value:t.searchCondition.region,callback:function(i){t.$set(t.searchCondition,"region",i)},expression:"searchCondition.region"}})],1)],1)])],1)],1),t._v(" "),e("Modal",{attrs:{width:300},model:{value:t.addCityModalShow,callback:function(i){t.addCityModalShow=i},expression:"addCityModalShow"}},[e("MRegionSelect",{staticStyle:{margin:"20px 0"},attrs:{"change-on-select":"",styles:"width:100%;",level:2},on:{"on-change":t.handleNewRegionSelected},model:{value:t.newRegion,callback:function(i){t.newRegion=i},expression:"newRegion"}}),t._v(" "),e("Button",{attrs:{type:"primary"},on:{click:t.handleFinishSelectNewRegion}},[t._v("添加")]),t._v(" "),e("Button",{on:{click:t.hideAddCityModel}},[t._v("取消")]),t._v(" "),e("div",{attrs:{slot:"footer"},slot:"footer"})],1)],1)},staticRenderFns:[]}},ui8w:function(t,i,e){var n=e("VU/8")(e("wEtk"),e("0bZq"),null,null);t.exports=n.exports},wEtk:function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=null,o=null;i.default={name:"app",data:function(){return{api:{path:"/boss/education/school/region/find-list",params:{fields:"{hot_cities{index,id,parent_id,name,pinyin,province{name}}}",limit:24}},pageInfoApi:{path:"/boss/education/school/region/list-page-info",params:{}},add:{api:{path:"/boss/education/school/region/add"}},updateHotApi:{api:{path:"/boss/education/school/region/update-hot"}},removeCityApi:{api:{path:"/boss/education/school/region/remove"}},sortInfoApi:{path:"/boss/education/school/region/sort",params:{provinceId:0}},sortable:!0,addCityModalShow:!1,columns:[{title:"省份",key:"provinceName"},{title:"城市",key:"cityName"},{title:"是否是优先展示城市",key:"isHot",render:function(t,i){return i.row.isHot?t("span",{style:{color:"green"}},"是"):t("span",{style:{color:"red"}},"否")}},{title:"操作",key:"action",render:function(t,i){var e=[];return e.push(t("div",[t("i-button",{attrs:{type:"text"},on:{click:function(){o.removeCity(i.row.index)}}},"删除")])),i.row.isHot?e.push(t("div",[t("i-button",{attrs:{type:"text"},on:{click:function(){o.unSetHotCity(i.row.index)}}},"取消优先展示")])):e.push(t("div",[t("i-button",{attrs:{type:"text"},on:{click:function(){o.setHotCity(i.row.index)}}},"设置为优先展示城市")])),t("div",e)}}],responseHandle:function(t,i){n=i;var e=[];return null!==t.data.hot_cities&&t.data.hot_cities.map(function(t){e.push({provinceName:t.province.name,cityName:t.name,provinceId:parseInt(t.parent_id),cityId:parseInt(t.id),isHot:!1,index:parseInt(t.index)})}),t.data=o.calculateHotCityField(e),t},searchConditionHandle:function(t){var i=0;return delete o.sortInfoApi.params.provinceId,t.region&&(i=void 0===t.region[0]?0:t.region[0],t.provinceId=i,o.sortInfoApi.params.provinceId=i,o.sortable=0===parseInt(i)),t},searchCondition:{region:[]},newRegion:[],defaultCity:[],defaultCityBack:[],newRegionData:{provinceId:0,cityId:0,provinceName:"",cityName:""},hotCityIds:[]}},methods:{handlePageInfoSuccess:function(t){var i=this;this.$nextTick(function(){var e=[];t.data.filter.hotCityIds.map(function(t){e.push(parseInt(t))}),i.hotCityIds=e;var n=t.data.filter.default.city_id,o=t.data.filter.default.province_id;i.defaultCity=[o,n],i.defaultCityBack=[o,n],i.calculateHotCityField()})},calculateHotCityField:function(t){var i=this;return void 0===t&&(t=n.data),t.map(function(e,n){i.hotCityIds.indexOf(parseInt(e.cityId))>=0&&(t[n].isHot=!0)}),void 0===t&&(n.data=t),t},hideAddCityModel:function(){this.addCityModalShow=!1},addCity:function(){this.rewindNewRegionData(),o.addCityModalShow=!0},rewindNewRegionData:function(){this.newRegionData.provinceName="",this.newRegionData.cityName="",this.newRegionData.provinceId=0,this.newRegionData.cityId=0,this.newRegion=[]},setHotCity:function(t){var i=this,e=n.data[t%this.api.params.limit],o=e.provinceId,a=e.cityId;this.submitUpdateHot(o,a,!0,function(){n.data[t%i.api.params.limit].isHot=!0,i.hotCityIds.push(parseInt(a)),i.calculateHotCityField()})},unSetHotCity:function(t){var i=this,e=n.data[t%this.api.params.limit],o=e.provinceId,a=e.cityId;this.submitUpdateHot(o,a,!1,function(){n.data[t%i.api.params.limit].isHot=!1;var e=i.hotCityIds.indexOf(parseInt(a));e>=0&&i.hotCityIds.splice(e,1),i.calculateHotCityField()})},removeCity:function(t){var i=n.data[t%this.api.params.limit],e=i.provinceId,o=i.cityId;this.submitRemoveCity(e,o,function(){window.location.reload()})},handleNewRegionSelected:function(t,i){this.newRegionData.provinceName=i[0].label,this.newRegionData.cityName=i[1].label,this.newRegionData.provinceId=parseInt(t[0]),this.newRegionData.cityId=parseInt(t[1]),this.newRegionData.ordering=-999},handleFinishSelectNewRegion:function(){var t=!1;if(n.data.map(function(i){i.cityId===o.newRegionData.cityId&&(o.$Notice.error({title:"城市已存在",desc:""}),t=!0)}),!t){var i={provinceName:this.newRegionData.provinceName,cityName:this.newRegionData.cityName,provinceId:this.newRegionData.provinceId,cityId:this.newRegionData.cityId,isHot:!1,ordering:this.newRegionData.ordering};n.data.push(i),this.submitAddCities(i,!0),this.hideAddCityModel()}},submitAddCities:function(t,i){var e=this;bus.$emit("on-loading");var n={cities:[t]};this.$Util.api.post(this.add,n).then(function(t){e.$Notice.success({title:"操作成功",desc:""}),i?window.location.reload():bus.$emit("on-loading")},function(t){bus.$emit("on-loading");var i="";3e4===parseInt(t.code)&&(i="城市已存在"),e.$Notice.error({title:"新增城市失败",desc:i})})},submitUpdateHot:function(t,i,e,n){var o=this;bus.$emit("on-loading");var a={provinceId:t,cityId:i,isHot:e};this.$Util.api.post(this.updateHotApi,a).then(function(t){o.$Notice.success({title:"操作成功",desc:""}),n(),bus.$emit("on-loading")},function(t){bus.$emit("on-loading");var i="";30001===parseInt(t.code)&&(i=t.extra.province.name+" 的优先展示城市为 "+t.extra.name+",请取消后再设置"),o.$Notice.error({title:"设置失败",desc:i})})},submitRemoveCity:function(t,i,e){var n=this;bus.$emit("on-loading");var o={provinceId:t,cityId:i};this.$Util.api.post(this.removeCityApi,o).then(function(t){n.$Notice.success({title:"操作成功",desc:""}),e(),bus.$emit("on-loading")},function(t){bus.$emit("on-loading"),n.$Notice.error({title:"删除请求失败",desc:""})})},handleDefaultCitySelect:function(t,i){void 0!==i[1]&&(confirm("确认将默认城市设置为"+i[0].label+"/"+i[1].label+"?")?(bus.$emit("on-loading"),vm.$Util.api.post({api:{path:"/boss/education/school/region/update-default-city"}},{cityId:t[1]},vm).then(function(i){0===parseInt(i.error_code)?(vm.$Notice.success({title:"设置成功",desc:""}),bus.$emit("on-loading"),o.$nextTick(function(){o.$set(o.defaultCityBack,0,t[0]),o.$set(o.defaultCityBack,1,t[1])})):(vm.$Notice.warning({title:"设置失败",desc:i.error_description}),bus.$emit("on-loading"),o.rollbackDefaultCityConfig())},function(t){bus.$emit("on-loading"),alert(t),o.rollbackDefaultCityConfig()})):this.rollbackDefaultCityConfig())},rollbackDefaultCityConfig:function(){this.$nextTick(function(){this.$set(this.defaultCity,0,this.defaultCityBack[0]),this.$set(this.defaultCity,1,this.defaultCityBack[1])})}},created:function(){o=this}}}});