webpackJsonp([264],{KkQJ:function(e,t){e.exports={render:function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("m-page",[i("Form",{ref:"formItem",attrs:{model:e.formItem,"label-width":100,rules:e.ruleInline,enctype:"multipart/form-data"}},[i("m-card",[i("Form-item",{attrs:{label:"安卓标题",prop:"android_title"}},[i("Input",{staticStyle:{width:"300px"},model:{value:e.formItem.android_title,callback:function(t){e.$set(e.formItem,"android_title",t)},expression:"formItem.android_title"}})],1),e._v(" "),i("Form-item",{attrs:{label:"安卓摘要",prop:"android_description"}},[i("Input",{staticStyle:{width:"300px"},model:{value:e.formItem.android_description,callback:function(t){e.$set(e.formItem,"android_description",t)},expression:"formItem.android_description"}})],1),e._v(" "),i("Form-item",{attrs:{label:"苹果通知内容",prop:"ios_description"}},[i("Input",{staticStyle:{width:"300px"},model:{value:e.formItem.ios_description,callback:function(t){e.$set(e.formItem,"ios_description",t)},expression:"formItem.ios_description"}})],1),e._v(" "),i("Form-item",{attrs:{label:"消息配图"}},[i("m-upload-image",{attrs:{"default-images":e.formItem.image},on:{"on-success":e.getImage}}),e._v("\n                配图只对iOS10设备有效\n            ")],1),e._v(" "),i("Form-item",{attrs:{label:"跳转路由",prop:"app_route"}},[i("m-app-route",{attrs:{placeholder:"输入路由","default-route":e.formItem.app_route},on:{"on-ok":e.getRoute}})],1)],1),e._v(" "),i("m-card",[i("Form-item",{attrs:{label:"接收人群"}},[i("Radio-group",{on:{"on-change":e.handleReceiveTypeChanged},model:{value:e.audience.type,callback:function(t){e.$set(e.audience,"type",t)},expression:"audience.type"}},[i("Radio",{attrs:{label:"TAG"}},[e._v("\n                        标签用户\n                    ")]),e._v(" "),i("Radio",{attrs:{label:"ALL"}},[e._v("\n                        全量用户\n                    ")]),e._v(" "),i("Radio",{attrs:{label:"UID"}},[e._v("\n                        指定UID\n                    ")]),e._v(" "),i("Radio",{attrs:{label:"FILE"}},[e._v("\n                        文件播\n                    ")]),e._v(" "),i("Radio",{attrs:{label:"ONEKEY"}},[e._v("\n                        一键播\n                    ")])],1),e._v(" "),"UID"==e.audience.type?i("Row",[i("i-col",{staticStyle:{width:"300px"}},[i("Input",{staticStyle:{width:"300px"},attrs:{type:"textarea",rows:e.textareaRows,placeholder:"英文逗号隔开"},model:{value:e.audience.uids,callback:function(t){e.$set(e.audience,"uids",t)},expression:"audience.uids"}})],1)],1):e._e(),e._v(" "),i("Row",{directives:[{name:"show",rawName:"v-show",value:"TAG"==e.audience.type||"ONEKEY"==e.audience.type,expression:"audience.type=='TAG' || audience.type=='ONEKEY'"}]},[i("Select",{staticStyle:{width:"80px"},model:{value:e.audience.tags_op,callback:function(t){e.$set(e.audience,"tags_op",t)},expression:"audience.tags_op"}},[i("Option",{attrs:{value:"UNION"}},[e._v("并集")]),e._v(" "),i("Option",{attrs:{value:"INTERSECTION"}},[e._v("交集")]),e._v(" "),i("Option",{attrs:{value:"EXCEPT"}},[e._v("差集")]),e._v(" "),i("Option",{attrs:{value:"NOT"}},[e._v("非")])],1),e._v(" "),i("Select",{staticStyle:{width:"300px"},attrs:{multiple:"",filterable:"",remote:"","remote-method":e.getUserTagsForSelect,loading:e.loadingUserTag},model:{value:e.audience.tags,callback:function(t){e.$set(e.audience,"tags",t)},expression:"audience.tags"}},e._l(e.userTags,function(t){return i("Option",{key:t,attrs:{value:t.tag}},[e._v(e._s(t.name))])}))],1),e._v(" "),i("Row",{directives:[{name:"show",rawName:"v-show",value:"FILE"==e.audience.type,expression:"audience.type=='FILE'"}]},[i("Upload",{attrs:{"before-upload":e.handleUpload,action:"apiConfig.create.api.path",accept:".xls,.xlsx,.csv"}},[i("Button",{attrs:{type:"ghost",icon:"ios-cloud-upload-outline"}},[e._v("选择要上传文件的文件")])],1),e._v(" "),null!==e.file?i("div",[e._v("待上传文件："+e._s(e.file.name)+"\n                    ")]):e._e()],1)],1)],1),e._v(" "),i("m-card",[i("Form-item",{attrs:{label:"发送时间",prop:"push_time"}},[i("Radio-group",{model:{value:e.sendTimeType,callback:function(t){e.sendTimeType=t},expression:"sendTimeType"}},[i("Radio",{attrs:{label:"sendNow"}},[e._v("\n                        立即发送\n                    ")]),e._v(" "),i("Radio",{attrs:{label:"sendFixedTime"}},[e._v("\n                        定时发送 (定时仅支持全量、标签、文件播,定时不能超过7天)\n                    ")])],1),e._v(" "),"sendFixedTime"==e.sendTimeType?i("Row",[i("i-col",{staticStyle:{width:"300px"}},[i("Date-picker",{attrs:{type:"datetime",format:"yyyy-MM-dd HH:mm:ss",placeholder:"于选定时间发送",disabled:e.setTiming,options:e.selectPushTime},on:{"on-ok":e.changePushTime},model:{value:e.formItem.push_time,callback:function(t){e.$set(e.formItem,"push_time",t)},expression:"formItem.push_time"}})],1)],1):e._e()],1),e._v(" "),i("Form-item",{attrs:{label:"消息过期时间",prop:"expires_time"}},[i("Row",[i("i-col",{staticStyle:{width:"300px"}},[i("Date-picker",{attrs:{type:"datetime",format:"yyyy-MM-dd HH:mm:ss",placeholder:"选择日期"},model:{value:e.formItem.expires_time,callback:function(t){e.$set(e.formItem,"expires_time",t)},expression:"formItem.expires_time"}})],1)],1)],1)],1),e._v(" "),i("Form-item",[i("i-button",{attrs:{type:"primary",disabled:e.submitEnable},on:{click:function(t){e.handleSubmit()}}},[e._v("提交")]),e._v(" "),i("i-button",{staticStyle:{"margin-left":"8px"},attrs:{type:"ghost"},on:{click:e.back}},[e._v("取消")])],1)],1)],1)},staticRenderFns:[]}},Lh2D:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a={getUserTags:{api:{path:"/admin.php?m=Admin&c=User&a=getUserTags",params:{tags:"",tag_name:""}}},create:{api:{path:"/boss/backend/push/create"}}};t.default={name:"add",data:function(){return{submitEnable:!1,formItem:{android_title:"",android_description:"",ios_description:"",image:"",app_route:"",push_time:"",expires_time:this.getDefaultExpiresTime()},sendTimeType:"sendNow",audience:{type:"TAG",tags_op:"UNION",tags:[],uids:""},loadingUserTag:!1,ruleInline:{android_title:[{required:!0,message:"安卓标题能为空",trigger:"blur"}],android_description:[{required:!0,message:"安卓摘要不能为空",trigger:"blur"}],ios_description:[{required:!0,message:"苹果通知内容不能为空",trigger:"blur"}],expires_time:[{required:!0,message:"结束时间不能为空",trigger:"blur"}]},confirmToPush:!0,file:"",setTiming:!1,selectPushTime:{disabledDate:function(e){return!!(e&&e.valueOf()>Date.now()+5184e5)}}}},methods:{getUserTagsForSelect:function(e){""!=e?(a.getUserTags.api.params.tag_name=e,a.getUserTags.api.params.tags="",this.loadingUserTag=!0,this.$Util.api.get(a.getUserTags,this).then(function(e){if(this.loadingUserTag=!1,!e.data)return this.$Message.warning("数据不存在或数据有误"),!1;e.data.length>100?this.$Message.warning("数据太多不能加载，请用更精确关键词搜索"):this.userTags=e.data},function(e){})):this.userTags=[]},handleSubmit:function(){var e=this;if(!this.validateFormData())return!1;this.submitEnable=!0;var t=this.getRequestParams(),i={};i=a.create.api.path,bus.$emit("on-loading");var s=this;this.$http.post(i,t,s).then(function(t){0==t.data.error_code?e.$Message.info("发送成功，请留意数据"):e.$Message.error(t.data.error_description),setTimeout(function(){e.back()},4e3)},function(e){}).then(function(t){e.msg=t})},getRequestParams:function(){var e=new FormData;if(e.append("android_title",this.formItem.android_title),e.append("android_description",this.formItem.android_description),e.append("ios_description",this.formItem.ios_description),e.append("app_route",this.formItem.app_route),this.formItem.image&&e.append("image",this.formItem.image[0].url),this.formItem.push_time){var t=Date.parse(new Date(this.formItem.push_time));e.append("push_time",t/1e3)}if(this.formItem.expires_time){var i=Date.parse(new Date(this.formItem.expires_time));e.append("expires_time",i/1e3)}var a=this.audience.type;return"UID"==this.audience.type?a=a+"|"+this.audience.uids:"TAG"!=this.audience.type&&"ONEKEY"!=this.audience.type||(a=a+"|"+this.audience.tags_op+"|"+this.audience.tags.join(",")),e.append("audience",a),this.file&&e.append("file",this.file),e},validateFormData:function(){return""==this.formItem.push_time&&"sendFixedTime"==this.sendTimeType?(this.$Notice.warning({title:"请填写定时发送的时间",desc:""}),!1):""!=this.formItem.push_time&&this.formItem.push_time>=this.formItem.expires_time?(this.$Notice.warning({title:"失效时间必须大于发送时间",desc:""}),!1):"UID"==this.audience.type&&""==this.audience.uids?(this.$Notice.warning({title:"指定UID不能为空",desc:""}),!1):"TAG"==this.audience.type&&""==this.audience.tags?(this.$Notice.warning({title:"用户标签不能为空",desc:""}),!1):"FILE"!=this.audience.type||this.file?(this.confirm(),this.confirmToPush):(this.$Notice.warning({title:"请上传表格",desc:""}),!1)},getRoute:function(e){this.formItem.app_route=e},getImage:function(e){this.formItem.image=e},back:function(){this.$router.push("/boss/push/find-list")},changePushTime:function(){this.formItem.expires_time=this.getDefaultExpiresTime(this.formItem.push_time)},getDefaultExpiresTime:function(e){return e||(e=new Date),Date.parse(e)+864e5},confirm:function(){var e=this;"ALL"==this.audience.type&&this.$Modal.confirm({title:"提示",content:"确定要发送全量？",onOk:function(){e.confirmToPush=!0},onCancel:function(){e.confirmToPush=!1}})},handleUpload:function(e){return this.file=e,!1},upload:function(){var e=this;this.loadingStatus=!0,setTimeout(function(){e.file=null,e.loadingStatus=!1,e.$Message.success("上传成功")},1500)},handleReceiveTypeChanged:function(){this.setTiming=!1,"UID"==this.audience.type&&(this.sendTimeType="sendNow",this.setTiming=!0)}}}},fbHx:function(e,t,i){var a=i("VU/8")(i("Lh2D"),i("KkQJ"),null,null);e.exports=a.exports}});