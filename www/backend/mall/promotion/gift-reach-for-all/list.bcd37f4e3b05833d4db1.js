webpackJsonp([55],{"7nfU":function(t,e,i){var o=i("VU/8")(i("ZmKj"),i("K8z0"),null,null);t.exports=o.exports},K8z0:function(t,e){t.exports={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("m-page",[i("Form",{ref:"myForm",attrs:{model:t.formItem}},[i("Card",{staticStyle:{"margin-bottom":"10px"}},[i("p",{attrs:{slot:"title"},slot:"title"},[t._v("活动名称:"+t._s(t.promotion.name))]),t._v(" "),i("p",[t._v("活动Id:"+t._s(t.promotion.id))]),t._v(" "),i("p",[t._v("活动描述:"+t._s(t.promotion.desc))])]),t._v(" "),i("m-promotion-user-condition",{attrs:{user_condition:t.promotion.user_condition},on:{condition_change:t.refreshUserCondition}}),t._v(" "),i("Card",{staticStyle:{"margin-bottom":"10px"}},[i("div",{staticStyle:{margin:"5px"}},[t._v("条件商品(多个Goods_ID用英文逗号隔开)")]),t._v(" "),i("Input",{attrs:{type:"textarea",autosize:{minRows:2,maxRows:10},disabled:"disabled",placeholder:"全场满赠活动对全部商品生效，不支持自定义活动范围"}})],1),t._v(" "),i("Card",{staticStyle:{"margin-bottom":"10px"}},[i("div",{staticStyle:{margin:"5px"}},[t._v("\n                赠品计划赠送总数（非该活动独享库存。即，若赠品在同时普通销售，则该活动赠出数量可能不足“计划赠送总数”）\n                "),i("Button",{attrs:{type:"primary",icon:"ios-plus",size:"small"},on:{click:function(e){t.addGift(null)}}},[t._v("添加赠品")])],1),t._v(" "),i("table",{staticClass:"ivu-table",staticStyle:{width:"720px","margin-left":"50px"},attrs:{cellspacing:"0",cellpadding:"0",border:"0"}},[i("tr",[i("th",[i("div",{staticClass:"ivu-table-cell"},[t._v("赠送规格id")])]),t._v(" "),i("th",[i("div",{staticClass:"ivu-table-cell"},[t._v("计划赠送数量（非独享，库存不足则不再赠送）")])]),t._v(" "),i("th",[i("div",{staticClass:"ivu-table-cell"},[t._v("操作")])])]),t._v(" "),t._l(t.formItem.gift,function(e,o){return i("tr",[i("td",[i("div",{staticClass:"ivu-table-cell"},[i("Input",{staticStyle:{width:"100px"},attrs:{placeholder:"商品规格id"},on:{"on-change":function(e){t.checkRepeatSpecId(o)}},model:{value:e.goods_spec_id,callback:function(i){t.$set(e,"goods_spec_id",i)},expression:"giftItem.goods_spec_id"}})],1)]),t._v(" "),i("td",[i("div",{staticClass:"ivu-table-cell"},[i("Input-number",{staticStyle:{width:"100px"},attrs:{min:1,placeholder:""},model:{value:e.quantity,callback:function(i){t.$set(e,"quantity",i)},expression:"giftItem.quantity"}})],1)]),t._v(" "),i("td",[i("div",{staticClass:"ivu-table-cell"},[i("Button",{attrs:{type:"error",size:"small"},on:{click:function(e){t.removeGift(o)}}},[t._v("删除\n                                ")])],1)])])})],2)]),t._v(" "),i("Card",[i("div",{staticStyle:{margin:"5px"}},[t._v("阶梯设置\n                "),i("Button",{attrs:{type:"primary",icon:"ios-plus",size:"small"},on:{click:function(e){t.addLevel(null)}}},[t._v("添加阶梯")])],1),t._v(" "),t._l(t.formItem.level,function(e,o){return i("div",{staticStyle:{border:"1px solid #ddd","margin-bottom":"8px"}},[i("Row",{staticStyle:{margin:"5px"},attrs:{type:"flex",justify:"start"}},[i("p",{staticStyle:{margin:"8px 10px 10px 10px"}},[t._v("描述")]),t._v(" "),i("Col",{attrs:{span:"4"}},[i("Input",{staticStyle:{width:"130px"},on:{"on-change":function(e){t.handleAmountMinChange(o)}},model:{value:e.amount_min,callback:function(i){t.$set(e,"amount_min",i)},expression:"levelItem.amount_min"}},[i("span",{attrs:{slot:"prepend"},slot:"prepend"},[t._v("满")]),t._v(" "),i("span",{attrs:{slot:"append"},slot:"append"},[t._v("元")])])],1),t._v(" "),i("Col",{attrs:{span:"4"}},[i("Input",{staticStyle:{width:"180px"},attrs:{placeholder:"最多10个字符"},on:{"on-change":function(e){t.checkDescriptionLength(o)}},model:{value:e.description,callback:function(i){t.$set(e,"description",i)},expression:"levelItem.description"}},[i("span",{attrs:{slot:"prepend"},slot:"prepend"},[t._v("送")])])],1)],1),t._v(" "),i("Row",{staticStyle:{margin:"5px"},attrs:{type:"flex",justify:"start"}},[i("Col",{attrs:{span:"4"}},[i("Input",{staticStyle:{width:"180px"},on:{"on-change":function(e){t.handleAmountMinChange(o)}},model:{value:e.amount_min,callback:function(i){t.$set(e,"amount_min",i)},expression:"levelItem.amount_min"}},[i("span",{attrs:{slot:"prepend"},slot:"prepend"},[t._v("购买金额最小值")])])],1),t._v(" "),i("Col",{attrs:{span:"4"}},[i("Input",{staticStyle:{width:"180px"},attrs:{readonly:""},model:{value:e.amount_max,callback:function(i){t.$set(e,"amount_max",i)},expression:"levelItem.amount_max"}},[i("span",{attrs:{slot:"prepend"},slot:"prepend"},[t._v("购买金额最大值")])])],1),t._v(" "),i("Col",{attrs:{span:"4"}},[i("Button",{attrs:{type:"error"},on:{click:function(e){t.removeLevel(o)}}},[t._v("删除")])],1)],1),t._v(" "),i("div",{staticStyle:{margin:"10px auto 10px 50px"}},[t._v("赠送商品\n                    "),i("Button",{attrs:{type:"primary",icon:"ios-plus",size:"small"},on:{click:function(e){t.addLevelGift(null,o)}}},[t._v("\n                        添加赠送商品\n                    ")])],1),t._v(" "),i("table",{staticClass:"ivu-table",staticStyle:{width:"720px","margin-left":"50px"},attrs:{cellspacing:"0",cellpadding:"0",border:"0"}},[i("tr",[i("th",[i("div",{staticClass:"ivu-table-cell"},[t._v("商品规格id")])]),t._v(" "),i("th",[i("div",{staticClass:"ivu-table-cell"},[t._v("商品数量")])]),t._v(" "),i("th",[i("div",{staticClass:"ivu-table-cell"},[t._v("操作")])])]),t._v(" "),t._l(t.formItem.level[o].goods,function(e,n){return i("tr",[i("td",[i("div",{staticClass:"ivu-table-cell"},[i("Select",{staticStyle:{width:"100px"},model:{value:e.goods_spec_id,callback:function(i){t.$set(e,"goods_spec_id",i)},expression:"giftItem.goods_spec_id"}},t._l(t.formItem.gift,function(e){return i("Option",{key:e.goods_spec_id,attrs:{value:e.goods_spec_id}},[t._v(t._s(e.goods_spec_id)+"\n                                    ")])}))],1)]),t._v(" "),i("td",[i("div",{staticClass:"ivu-table-cell"},[i("Input-number",{staticStyle:{width:"100px"},attrs:{min:1},on:{"on-change":function(e){t.handleOptionalQuantityChange(o,n)}},model:{value:e.quantity,callback:function(i){t.$set(e,"quantity",i)},expression:"giftItem.quantity"}})],1)]),t._v(" "),i("td",[i("div",{staticClass:"ivu-table-cell"},[i("Button",{attrs:{type:"error",size:"small"},on:{click:function(e){t.removeLevelGift(o,n)}}},[t._v("删除\n                                ")])],1)])])})],2)],1)})],2),t._v(" "),i("Form-item",{staticStyle:{margin:"10px"}},[i("i-button",{attrs:{type:"primary"},on:{click:t.submit}},[t._v("提交")]),t._v(" "),i("i-button",{staticStyle:{"margin-left":"8px"},attrs:{type:"ghost"},on:{click:function(e){t.back()}}},[t._v("取消")])],1)],1)],1)},staticRenderFns:[]}},NZ6e:function(t,e,i){var o=i("z3la");"string"==typeof o&&(o=[[t.i,o,""]]),o.locals&&(t.exports=o.locals);i("rjj0")("0e3768df",o,!0)},QDqa:function(t,e){t.exports={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("m-page",[i("Card",{staticStyle:{"margin-bottom":"10px"}},[i("FormItem",[i("Row",[i("Col",[t._v("\n                活动允许参与人群\n                ")]),t._v(" "),i("Col",[i("RadioGroup",{model:{value:t.user_condition.type,callback:function(e){t.$set(t.user_condition,"type",e)},expression:"user_condition.type"}},[i("Radio",{attrs:{label:"1"}},[t._v("不限")]),t._v(" "),i("Radio",{attrs:{label:"2"}},[t._v("指定用户标签组")]),t._v(" "),i("Radio",{attrs:{label:"3"}},[t._v("指定UID")])],1)],1)],1)],1),t._v(" "),"2"==t.user_condition.type?i("FormItem",[i("Row",[i("Col",[t._v("\n                指定用户标签组:\n                ")]),t._v(" "),i("Col",[i("CheckboxGroup",{model:{value:t.user_condition.tag,callback:function(e){t.$set(t.user_condition,"tag",e)},expression:"user_condition.tag"}},t._l(t.userTags,function(e){return i("Checkbox",{key:e.tag,attrs:{label:e.tag}},[t._v(t._s(e.name))])}))],1)],1)],1):t._e(),t._v(" "),"3"==t.user_condition.type?i("FormItem",[i("Row",[i("Col",[t._v("\n                指定UID:\n                ")]),t._v(" "),i("Col",[i("Input",{staticStyle:{width:"300px"},attrs:{type:"textarea",autosize:{minRows:2,maxRows:5},placeholder:""},model:{value:t.user_condition.uids,callback:function(e){t.$set(t.user_condition,"uids",e)},expression:"user_condition.uids"}})],1)],1)],1):t._e(),t._v(" "),"4"==t.user_condition.type?i("FormItem",[i("Row",[i("Col",[t._v("\n                在指定时间周期内:\n                ")])],1),t._v(" "),i("Row",[i("Col",{attrs:{span:"10",label:"开始时间"}},[i("Date-picker",{attrs:{type:"datetime",placeholder:"选择开始时间",format:"yyyy-MM-dd HH:mm:ss"},model:{value:t.user_condition.condition_start_time,callback:function(e){t.$set(t.user_condition,"condition_start_time",e)},expression:"user_condition.condition_start_time"}})],1),t._v(" "),i("Col",{attrs:{span:"10",label:"结束时间"}},[i("Date-picker",{attrs:{type:"datetime",placeholder:"选择结束时间",format:"yyyy-MM-dd HH:mm:ss"},model:{value:t.user_condition.condition_end_time,callback:function(e){t.$set(t.user_condition,"condition_end_time",e)},expression:"user_condition.condition_end_time"}})],1)],1),t._v(" "),i("Row",[i("Col",[t._v("\n                购买过至少1款指定Goods_ID:(多个Goods_ID用英文逗号隔开)\n                ")]),t._v(" "),i("Col",[i("Input",{staticStyle:{width:"300px"},attrs:{type:"textarea",autosize:{minRows:2,maxRows:5},placeholder:"多个GoodsID英文逗号隔开"},model:{value:t.user_condition.has_purchased_goods_id,callback:function(e){t.$set(t.user_condition,"has_purchased_goods_id",e)},expression:"user_condition.has_purchased_goods_id"}})],1)],1)],1):t._e()],1)],1)},staticRenderFns:[]}},ZmKj:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=i("oIdx"),n=i.n(o),s={create:{api:{path:"/boss/mall/promotion/gift-reach-for-all/create"}},update:{api:{path:"/boss/mall/promotion/gift-reach-for-all/update",params:{promotion_id:0}}},find:{api:{path:"/boss/mall/promotion/gift-reach-for-all/find",params:{promotion_id:0,fields:"{id,name,desc,type,start_time,end_time,update_time,user_condition{type,condition,condition_start_time,condition_end_time},level{id,promotion_id,title,amount_min,amount_max,update_time,description,goods{id,goods_spec_id,quantity,stock}}}"}},responseHandle:function(t,e){return t}}};e.default={components:{MPromotionUserCondition:n.a},name:"MPromotionGiftReachForAll",data:function(){return{promotion:{name:"",title:"",desc:"",start_time:"",end_time:"",user_condition:{type:1}},formItem:{promotion_id:"",level:[{id:0,amount_min:"",amount_max:0,description:"",goods:[{id:0,goods_spec_id:"",quantity:1}]}],gift:[{goods_spec_id:"",quantity:1}]},usage:"edit",canSubmit:!0,requestParamsOfUserCondition:{type:1}}},methods:{back:function(){location.hash="/mall/promotion/promotion/list"},refreshUserCondition:function(t){this.requestParamsOfUserCondition=t},checkRepeatSpecId:function(t){var e=this.formItem.gift[t].goods_spec_id;for(var i in this.formItem.gift)i!=t&&this.formItem.gift[i].goods_spec_id===e&&this.$Message.error("已有重复赠送规格id")},checkDescriptionLength:function(t){this.formItem.level[t].description.length>10&&this.$Message.error("最多10个字符")},handleAmountMinChange:function(t){this.formItem.level[t].amount_max>0&&parseFloat(this.formItem.level[t].amount_min)>=parseFloat(this.formItem.level[t].amount_max)?this.$Message.error("购买金额最小值必须小于购买金额最大值"):t>0&&(parseFloat(this.formItem.level[t].amount_min)<=parseFloat(this.formItem.level[t-1].amount_min)?this.$Message.error("必须大于上一阶梯购买金额最小值"):this.formItem.level[t-1].amount_max=this.formItem.level[t].amount_min)},addGift:function(t){null==t&&(t={id:0,goods_spec_id:"",quantity:1}),this.formItem.gift.push(t)},removeGift:function(t){if(this.formItem.gift.length>1){var e=this.formItem.gift[t].goods_spec_id;if(this.checkLastLevelGiftBySpecId(e))return void this.$Message.error("不能删除阶梯最后一个赠品~");this.removeLevelGiftBySpecId(e),this.formItem.gift.splice(t,1)}},checkLastLevelGiftBySpecId:function(t){for(var e in this.formItem.level)for(var i in this.formItem.level[e].goods)if(this.formItem.level[e].goods[i].goods_spec_id===t&&1===this.formItem.level[e].goods.length)return!0;return!1},removeLevelGiftBySpecId:function(t){for(var e in this.formItem.level)for(var i in this.formItem.level[e].goods)this.formItem.level[e].goods[i].goods_spec_id===t&&this.formItem.level[e].goods.splice(i,1)},addLevel:function(t){null==t&&(t={id:0,amount_min:"",amount_max:0,description:"",goods:[{id:0,goods_spec_id:"",quantity:1}]}),this.formItem.level.push(t)},removeLevel:function(t){this.formItem.level.length>1&&(this.formItem.level.length==t+1?this.formItem.level[t-1].amount_max=0:t>0&&this.formItem.level.length>2&&(this.formItem.level[t-1].amount_max=this.formItem.level[t+1].amount_min),this.formItem.level.splice(t,1))},addLevelGift:function(t,e){null==t&&(t={id:0,goods_spec_id:"",quantity:1}),this.formItem.level[e].goods.push(t)},removeLevelGift:function(t,e){this.formItem.level[t].goods.length>1&&this.formItem.level[t].goods.splice(e,1)},submit:function(){bus.$emit("reset-submit"),bus.$emit("on-submit"),setTimeout(function(){bus.$emit("do-submit")},300)},validateFormData:function(){if(this.formItem.level.length<1)return this.$Message.error("至少填写1个阶梯设置!"),!1;for(var t=0;t<this.formItem.level.length;t++){var e=this.formItem.level[t];if(""==e.amount_min||isNaN(e.amount_min))return this.$Message.error("购买金额最小值不能为空，必须为数字"),!1;if(0!=e.amount_max&&(""==e.amount_max||isNaN(e.amount_max)))return this.$Message.error("购买金额最大值不能为空，必须为数字"),!1;if(e.amount_min=parseFloat(e.amount_min),e.amount_max=parseFloat(e.amount_max),this.formItem.level.length!=t+1&&e.amount_min>=e.amount_max)return this.$Message.error("购买金额最小值必须小于最大值,"+e.amount_min+"<"+e.amount_max),!1;if(""==e.description||e.description.length>10)return this.$Message.error("描述不能为空,且不能大于10个字符"),!1;var i={};for(var o in e.goods){if(""==e.goods[o].goods_spec_id||isNaN(e.goods[o].goods_spec_id))return this.$Message.error("换购商品规格ID不能为空，必须为数字"),!1;if(""==e.goods[o].quantity||isNaN(e.goods[o].quantity))return this.$Message.error("商品数量不能为空，必须为数字"),!1;if(i[e.goods[o].goods_spec_id])return this.$Message.error("换购商品规格ID重复，ID="+e.goods[o].goods_spec_id),!1;i[e.goods[o].goods_spec_id]=!0}}for(var n=0;n<this.formItem.level.length;n++)for(var t=n+1;t<this.formItem.level.length;t++)if(!(this.formItem.level[n].amount_min>=this.formItem.level[t].amount_max||this.formItem.level[n].amount_max<=this.formItem.level[t].amount_min)){var s="["+this.formItem.level[n].amount_min+","+this.formItem.level[n].amount_max+"]";return s+="，["+this.formItem.level[t].amount_min+","+this.formItem.level[t].amount_max+"]",this.$Message.error("阶梯区间不能重合"+s),!1}return!0},getRequestParams:function(){var t={};return t=this.formItem,t.type=8,t.user_condition=this.requestParamsOfUserCondition,t},submitRequest:function(){bus.$emit("on-loading");var t=this;if(!t.validateFormData())return bus.$emit("on-loading"),bus.$emit("prevent-submit"),!1;var e=t.getRequestParams(),i=s.create;"edit"===t.usage&&(i=s.update),this.$Util.api.post(i,e,t).then(function(e){bus.$emit("on-loading"),t.$Notice.success({title:"请求成功",desc:""}),t.back()},function(e){bus.$emit("on-loading"),t.$Notice.warning({title:"请求失败",desc:e.error_description})})},loadEditFormData:function(){var t=this;bus.$emit("on-loading"),this.$Util.api.get(s.find,this).then(function(e){if(bus.$emit("on-loading"),!e.data)return t.$Message.warning("数据不存在"),!1;if(t.promotion.id=e.data.id,t.promotion.name=e.data.name,t.promotion.desc=e.data.desc,null!==e.data.user_condition&&this.$set(t.promotion,"user_condition",e.data.user_condition),void 0===e.data.level||0==e.data.level.length)t.usage="add";else{var i=[],o=[];for(var n in e.data.level)for(var s in e.data.level[n].goods)if(!o[e.data.level[n].goods[s].goods_spec_id]){var a={};a.goods_spec_id=e.data.level[n].goods[s].goods_spec_id,a.quantity=e.data.level[n].goods[s].stock,i.push(a),o[e.data.level[n].goods[s].goods_spec_id]=!0}t.formItem.gift=i,t.formItem.level=e.data.level}},function(t){})}},created:function(){s.update.api.params.promotion_id=this.$route.params.id,s.find.api.params.promotion_id=this.$route.params.id,this.formItem.promotion_id=this.$route.params.id,this.$nextTick(function(){var t=this;t.loadEditFormData(),bus.$on("prevent-submit",function(){t.canSubmit=!1}),bus.$on("reset-submit",function(){t.canSubmit=!0}),bus.$on("do-submit",function(){t.canSubmit&&t.submitRequest()})})},beforeDestroy:function(){bus.$off("prevent-submit"),bus.$off("reset-submit"),bus.$off("on-submit"),bus.$off("do-submit")}}},oIdx:function(t,e,i){i("NZ6e");var o=i("VU/8")(i("s1ay"),i("QDqa"),null,null);t.exports=o.exports},s1ay:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default={name:"MPromotionUserCondition",props:{user_condition:{type:Object,default:function(){return{type:"1",tag:[],uids:"",condition_start_time:"",condition_end_time:"",has_purchased_goods_id:""}}}},data:function(){return{userTags:[],hasInitialed:0,findTags:{api:{path:"/boss/mall/promotion/user-condition/tag"},responseHandle:function(t,e){return t}}}},watch:{user_condition:{handler:function(t,e){if(!this.hasInitialed)if(2==t.type){var i=this.user_condition.condition?this.user_condition.condition.split(","):[];this.$set(this.user_condition,"tag",i)}else 3==t.type?this.$set(this.user_condition,"uids",this.user_condition.condition):4==t.type&&(this.user_condition.condition_start_time&&"number"==typeof this.user_condition.condition_start_time&&(this.user_condition.condition_start_time=1e3*parseInt(this.user_condition.condition_start_time)),this.user_condition.condition_end_time&&"number"==typeof this.user_condition.condition_end_time&&(this.user_condition.condition_end_time=1e3*parseInt(this.user_condition.condition_end_time)),this.user_condition.condition_start_time&&"number"!=typeof this.user_condition.condition_start_time&&(this.user_condition.condition_start_time=Date.parse(this.user_condition.condition_start_time)),this.user_condition.condition_end_time&&"number"!=typeof this.user_condition.condition_end_time&&(this.user_condition.condition_end_time=Date.parse(this.user_condition.condition_end_time)),this.$set(this.user_condition,"has_purchased_goods_id",this.user_condition.condition));this.hasInitialed=!0;var o=Object.assign({},this.user_condition);"4"==this.user_condition.type&&(o.condition_start_time=o.condition_start_time.toString(),o.condition_end_time=o.condition_end_time.toString()),this.$emit("condition_change",o)},deep:!0}},methods:{validateFormData:function(){if(""==this.user_condition.type)return this.$Message.error("允许参与人群不能为空"),!1;if("2"==this.user_condition.type&&(!this.user_condition.tag||this.user_condition.tag.length<=0))return this.$Message.error("指定用户标签组不能为空"),!1;if("3"==this.user_condition.type&&(!this.user_condition.uids||""==this.user_condition.uids))return this.$Message.error("指定UID不能为空"),!1;if("4"==this.user_condition.type){if(""===this.user_condition.has_purchased_goods_id)return this.$Message.error("购买过至少1款指定Goods_ID不能为空"),!1;if(""==this.user_condition.condition_start_time)return this.$Message.error("在指定时间周期内的开始时间不能为空"),!1;if(""==this.user_condition.condition_end_time)return this.$Message.error("在指定时间周期内的结束时间不能为空"),!1}return!0},loadData:function(){var t=this;this.$Util.api.get(t.findTags,this).then(function(e){if(!e.data)return t.$Message.warning("数据不存在"),!1;t.userTags=e.data},function(t){})}},created:function(){this.$nextTick(function(){var t=this;bus.$on("on-submit",function(){t.validateFormData()||bus.$emit("prevent-submit")}),t.loadData()})}}},z3la:function(t,e,i){e=t.exports=i(0)(),e.push([t.i,"p{margin:5px}",""])}});