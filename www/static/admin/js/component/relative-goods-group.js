define("component/relative-goods-group",["common/util"],function(o){function t(){var o={},t={},e=this,d=function(){var e=o.goods,d="";for(var i in e){var s=e[i]||{},n=$(a.template.goods.replace(/\{\{goods_id\}\}/g,s.goods_id)),r=[];if(void 0!==s.goods_id){for(var c=0,l=s.specs.length;c<l;c++)r.push(s.specs[c].goods_item_id);s.specs_str=r.join(","),s.name=s.name||s.title||"";for(field in s){var p=field.replace(/\_/g,"-");"cover"==p?n.find("[data-"+p+"]:first").html('<img src="'+s[field]+'" style="max-height: 50px;"/>'):n.find("[data-"+p+"]:first").html(s[field])}d+="<tr>"+n.html()+"</tr>"}}t.find("tbody").html(d)};this.getGroup=function(){return o},this.setGoods=function(t,e){o.goods=o.goods||{},o.goods[t]=e,d();var i=[];console.log(a.storage.ids);for(var s in a.storage.ids)a.storage.ids[s].length>0&&i.push(a.storage.ids[s].join(","));i.length>0&&a.obj.find("[name=relative_id]").val(i.join(","))};var i=function(t){var e="";return o.group_id=o.group_id||0,$(a.storage.groups).each(function(t,d){var a=d.id==o.group_id?"selected":"";e+="<option "+a+' value="'+d.id+'">'+d.name+"</option>"}),t.find("[name=relative-goods-group-id]").html(e),t};this.init=function(s){o=s,t=i($(a.template.goodsGroup)),a.obj.find(".goods-group").append(t),d(),t.on("click",".js-add-goods",function(){a.Action.action="add",a.Action.setObj(e),a.Action._render()}),t.on("click",".js-edit-goods",function(){var t=o.goods[$(this).attr("data-goods-id")]||{};a.Action.action="edit",a.Action.setObj(e),a.Action.setTempGoods(t)}),t.on("click",".js-remove-goods",function(){return!!confirm("你确定要删除吗?")&&(a.Action.action="remove",a.Action.setObj(e),void a.Action._remove($(this).attr("data-goods-id"),1))}),a.storage.goodsGroups.push(this)}}function e(o){o=o||$(document);var t=o.find('[data-component="'+d+'"]');t.each(function(o,t){var e={component:$(t),objType:$(t).attr("data-obj-type"),objId:$(t).attr("data-obj-id"),needSpec:$(t).attr("data-need-spec")};a.init(e)})}var d=(o("common/util"),"relative-goods-group"),a={options:{},Obj:{},template:{base:'<style>.table-align-center th,.table-align-center td{text-align:center}.relative-goods{padding:10px;border:1px solid #ccc;margin-bottom:10px}.relative-goods-table{max-height:296px}.relative-goods-table table{display:none}.relative-goods-table .active{display:table}</style><span class="sui-btn btn-block btn-xlarge btn-primary js-add-goods-group">添加组</span><div class="goods-group"></div><div class="action-area"><div id="action-add-goods" tabindex="-1" role="dialog" data-hasfoot="false" class="sui-modal hide fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×</button><h4 id="" class="modal-title">添加商品</h4></div><div class="modal-body relative-goods-table"><table class="sui-table table-bordered active" id="relative-goods-table1"><tr><th>GOODS_ID</th><td><input type="text" class="textinput" size="30" name="temp_goods_id" value=""> <span class="sui-btn btn-bordered btn-primary js-search-goods">搜索</span></td></tr><tr><th>商品名称</th><td><input type="text" class="textinput" size="30" name="temp_name"></td></tr><tr><th>商品描述</th><td><input type="text" class="textinput" size="30" name="temp_desc"></td></tr><tr><th>商品图片</th><td><img style="max-height: 50px" data-cover src="" /></td></tr><tr><td colspan="2" style="text-align: center"><span class="sui-btn btn-bordered btn-primary js-next" href="#relative-goods-table2">下一步</span>&nbsp;&nbsp;<span class="sui-btn btn-bordered btn-primary js-reset" href="#relative-goods-table2">重置</span></td></tr></table><table class="sui-table table-bordered table-align-center " id="relative-goods-table2"><thead><tr><th>选项</th><th>SPEC_ID</th><th>规格组合名称</th><th>数量</th></tr></thead><tbody><tr><td><input type="checkbox" name="temp_spec_id" value="{{id}}"></td><td>1</td><td>红色</td><td>16ml</td><td>1</td><td>2</td><td>3</td><td><input type="text" name="temp_spec_count" size="3" value="1"></td></tr><tr><td colspan="8"><span class="sui-btn btn-bordered btn-primary js-prev" href="#relative-goods-table1">上一步</span>&nbsp;&nbsp;<span class="sui-btn btn-bordered btn-primary js-save-goods" href="#relative-goods-table2">保存</span></td></tr></tbody></table></div></div></div></div></div><input type="hidden" name="relative_id">',goodsGroup:'<div class="relative-goods-group"><div class="relative-goods"><p>标题: <span><select name="relative-goods-group-id" ><option value="1">提及商品</option><option value="2">推荐商品</option></select></span> <span data-toggle="modal" data-target="#action-add-goods" data-keyboard="false" data-backdrop="false"  class="sui-btn btn-bordered btn-primary js-add-goods">添加商品</span></p><table class="sui-table table-bordered table-zebra table-align-center"><thead><tr><th>GOODS_ID</th><th style="min-width: 80px;">商品图片</th><th>商品名称</th><th>商品描述</th><th>规格列表</th><th style="min-width: 80px;">操作</th></tr></thead><tbody></tr></tbody></table></div></div>',goods:'<tr><td data-goods-id></td><td data-cover></td><td data-name></td><td data-desc></td><td data-specs-str></td><td><a href="javascript:void(0);" data-goods-id="{{goods_id}}" data-toggle="modal" data-target="#action-add-goods" data-keyboard="false" data-backdrop="false"   class="js-edit-goods">编辑</a>|<a href="javascript:void(0);" data-goods-id="{{goods_id}}" class="js-remove-goods">删除</a></td>',spec:'<tr><td><input type="checkbox" {{checked}} name="id" value="{{id}}"></td><td>{{goods_item_id}}<input type="hidden" name="temp_spec_id" value="{{goods_item_id}}"></td><td>{{spec_name}}</td><td><input type="text" name="temp_spec_count" size="3" value="{{count}}"></td></tr>'},storage:{groups:[],goodsGroups:[],goods:{},ids:{}},api:{getRelativeGoodsGroups:"/admin.php?m=Admin&c=RelativeMallGoodsGroup&a=lists",getRelativeGoods:"/admin.php?m=admin&c=RelativeMallGoods&a=lists",getGoodsDetail:"/admin.php?m=admin&c=RelativeMallGoods&a=getGoodsDetail",addRelativeGoods:"/admin.php?m=admin&c=RelativeMallGoods&a=add",editRelativeGoods:"/admin.php?m=admin&c=RelativeMallGoods&a=edit",removeRelativeGoods:"/admin.php?m=admin&c=RelativeMallGoods&a=remove"},groupInit:function(o){if(0==this.storage.groups.length){var t=this;$.get(this.api.getRelativeGoodsGroups,{},function(o){0==o.error_code?t.storage.groups=o.data.list:t.storage.groups=[{id:1,name:"提及商品1"},{id:2,name:"推荐商品2"}],t.goodsGroupInit()},"JSON")}},goodsGroupInit:function(){var o=this;$.get(this.api.getRelativeGoods,{obj_type:a.options.objType,obj_id:a.options.objId},function(e){if(0==e.error_code)for(var d=0,a=e.data.list.length;d<a;d++){e.data.list[d].newGoods={};for(var i=0,s=e.data.list[d].goods.length;i<s;i++)e.data.list[d].newGoods[e.data.list[d].goods[i].goods_id]=e.data.list[d].goods[i];e.data.list[d].goods=e.data.list[d].newGoods,delete e.data.list[d].newGoods;var n=new t;n.init(e.data.list[d])}else $.toast(e.error_desc);o.Action.init()},"JSON")},init:function(o){this.options=o,this.obj=o.component,this.obj.html(this.template.base),this.obj.on("click",".js-add-goods-group",function(){var o=new t;o.init({})}),this.groupInit()}};return a.Action={action:"add",obj:{},tempGoods:{},setObj:function(o){this.obj=o},setTempGoods:function(o){this.tempGoods=this._clone(o),this._render()},_addGoods:function(o){var t=this.obj.getGroup(),e=a.Action._clone(o);e.specs=[];for(var d={obj_id:a.options.objId,obj_type:a.options.objType,group_id:t.group_id,goods_id:o.goods_id,name:o.name,desc:o.desc,spec_info:""},i=[],s=0,n=o.specs.length;s<n;s++){var r=1;i.push(o.specs[s].goods_item_id+"|"+o.specs[s].count),e.specs.push({id:r,goods_item_id:o.specs[s].goods_item_id,count:o.specs[s].count})}d.spec_info=i.join(","),$.post(a.api.addRelativeGoods,d,function(o){var t="add"==a.Action.action?"添加":"修改";a.storage.ids[d.goods_id]=o.data,0==o.error_code?($.toast(t+"成功"),a.Action.obj.setGoods(d.goods_id,e)):$.toast(t+"失败,请联系管理员")},"JSON")},_removeGoods:function(o,t){var e=this.obj.getGroup(),d=e.goods[o];$.post("",{ids:t.join(",")},function(e){if(0==e.error_code){for(var i=0,s=d.specs.length;i<s;i++)t.indexOf(d.specs[i].id-0)&&d.specs.splice(i,1);a.obj.setGoods(o,d),$.toast("删除成功")}else $.toast("删除失败,稍后重试")})},_clone:function(o){var t={};for(key in o)t[key]=o[key];return t},_searchGoods:function(o,t){return o?void 0!=a.storage.goods[o]?("add"==a.Action.action&&(a.Action.tempGoods=a.Action._clone(a.storage.goods[o]),a.Action.tempGoods.specs=[]),void t()):void $.get(a.api.getGoodsDetail,{goods_id:o},function(e){0==e.error_code?(a.storage.goods[o]=a.Action._clone(e.data),"add"==a.Action.action&&(a.Action.tempGoods=a.Action._clone(a.storage.goods[o]),a.Action.tempGoods.specs=[]),t()):$.toast("商品不存在")},"JSON"):($.toast("商品ID不能为空"),!1)},_next:function(o){var t=a.obj.find("[name=temp_goods_id]").val()-0;if(!t)return $.toast("商品ID不能为空"),!1;if("edit"==this.action&&t!=a.Action.tempGoods.goods_id)return $.toast("如果要修改商品ID,请删除再添加~"),!1;a.Action.tempGoods.goods_id=t,a.Action.tempGoods.name=a.obj.find("[name=temp_name]").val(),a.Action.tempGoods.desc=a.obj.find("[name=temp_desc]").val();var e=a.storage.goods[a.Action.tempGoods.goods_id]||{};void 0==e.goods_id?this._searchGoods(a.Action.tempGoods.goods_id,this._renderSpec):this._renderSpec(),a.obj.find(".relative-goods-table table").removeClass("active"),$($(o).attr("href")).addClass("active")},_save:function(){var o=[];a.obj.find("[name=id]").each(function(t,e){if(e.checked){var d={id:e.value,goods_item_id:$(e).parent().parent().find("[name=temp_spec_id]").val(),count:$(e).parent().parent().find("[name=temp_spec_count]").val()};o.push(d)}a.Action.tempGoods.specs=o}),"add"==a.Action.action?this._addGoods(a.Action.tempGoods):"edit"==a.Action.action&&(this._remove(a.Action.tempGoods.goods_id,0),this._addGoods(a.Action.tempGoods)),a.Action.obj.setGoods(a.Action.tempGoods.goods_id,a.Action.tempGoods),$("#action-add-goods").modal("toggle")},_cancel:function(){a.Action.setTempGoods({}),$("#relative-goods-table1").addClass("active"),$("#relative-goods-table2").removeClass("active")},_remove:function(o,t){var e=this.obj.getGroup();$.post(a.api.removeRelativeGoods,{goods_id:o,obj_type:a.options.objType,obj_id:a.options.objId,group_id:e.group_id},function(e){t&&(0==e.error_code?$.toast("删除成功"):$.toast("删除失败"),a.Action.obj.setGoods(o,{})),console.log("删除成功")},"JSON")},_compileSpec:function(o){var t=a.template.spec;for(var e in o){var d=new RegExp("{{"+e+"}}","g");t=t.replace(d,o[e])}return t},_renderSpec:function(){var o={},t=[];$(a.Action.tempGoods.specs).each(function(){o[this.goods_item_id]=this,t.push(this.goods_item_id-0)});var e=a.storage.goods[a.Action.tempGoods.goods_id],d="";$(e.specs).each(function(e,i){t.indexOf(i.id-0)>-1?(i.checked="checked",i.count=o[i.id].count):(i.checked="",i.count=1),i.goods_item_id=i.id,d+=a.Action._compileSpec(i)}),$("#relative-goods-table2 tbody").find("tr:not(:last)").remove(),$("#relative-goods-table2 tbody").prepend(d)},_render:function(){var o=a.Action.tempGoods||{goods_id:"",name:"",decs:"",cover:"",specs:[]};$("[name=temp_goods_id]").val(o.goods_id),$("[name=temp_name]").val(o.name),$("[name=temp_desc]").val(o.desc),$("[data-cover]").attr("src",o.cover)},init:function(){this.obj=a.obj.find(".action-area"),$("#action-add-goods").on("cancelHide",this._cancel),a.obj.on("click",".js-next",function(){a.Action._next(this)}),a.obj.on("click",".js-prev",function(){a.obj.find(".relative-goods-table table").removeClass("active"),$($(this).attr("href")).addClass("active")}),a.obj.on("click",".js-save-goods",function(){a.Action._save()}),a.obj.on("click",".js-search-goods",function(){var o=a.obj.find("[name=temp_goods_id]").val()-0;a.Action._searchGoods(o,a.Action._render)})}},a.Apis={getRelativeGroups:"/admin.php?m=admin&c=RelativeMallGoodsGroup&a=list",getRelativeGoods:"/admin.php?m=admin&c=RelativeMallGoods&a=list",getGoodsDetail:"/v1/goods/1.json",addRelativeGoods:"/admin.php?m=admin&c=RelativeMallGoods&a=add",editRelativeGoods:"/admin.php?m=admin&c=RelativeMallGoods&a=edit",removeRelativeGoods:"/admin.php?m=admin&c=RelativeMallGoods&a=remove"},e});