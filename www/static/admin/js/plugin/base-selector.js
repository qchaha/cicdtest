define("plugin/base-selector",["plugins/datetime-picker"],function(t){"use strict";t("plugins/datetime-picker");var e=function(t){function a(t){console.log(i.settings),i.settings.notEncode||($("#utm_content").modal("show"),$(".js-example-basic-single").select2(),$(".js-example-basic-multiple").select2(),setTimeout(function(){$(document).off("focusin.modal")},500),$(".select2-search__field").width(300),$(".select2-search__field").removeAttr("tabindex"),$(".utm-btn").on("click",function(){var t=$(".utm-title").val(),e=$(".business").val(),a=$(".activity").val()&&$(".activity").val().join(","),o=$(".tags").val()&&$(".tags").val().join(","),l="content_title="+encodeURIComponent(t)+"&content_business="+encodeURIComponent(e)+"&content_act="+encodeURIComponent(a)+"&content_tags="+encodeURIComponent(o);s.route.indexOf("?")>0?s.route+="&"+l:s.route+="?"+l,i.settings.callback&&"function"==typeof i.settings.callback&&i.settings.callback(s),$(window).trigger("refreshEditorConfig"),$(".utm-btn").off("click")}));var s={route_id:$(".s_route_list .s_select").attr("route-id"),route_group:$(".s_route_list .s_select").attr("route-group"),name:$(".s_route_list .s_select").html(),route:"",params:{}};if(m&&!s.route_id&&"0"!==s.route_id)return alert("你还没选择路由~~"),!1;for(var o=i.selectorData[s.route_group].items[s.route_id].name,l=0;l<$(".s_param ul > li").length;l++){var n=i.settings.notEncode?$(".s_param ul > li").eq(l).find("input").val():encodeURIComponent($(".s_param ul > li").eq(l).find("input").val()),r=$(".s_param ul > li").eq(l).find("input").attr("data-can-null");if("自定义"==o&&(n=decodeURIComponent(n)),!n&&0==r)return alert('"'+$(".s_param ul > li").eq(l).find("p").html()+'">>参数不能为空<<'),!1;s.params[$(".s_param ul > li").eq(l).find("p").attr("data-name")]=n}s.route=i.selectorData[s.route_group].items[s.route_id].route;for(var l in s.params){var c=new RegExp("(:"+l+")","g");if(s.route=s.route.replace(c,s.params[l].trim()),i.commonParams&&i.commonParams[l]&&s.params&&!s.params[l]){var c=new RegExp("([&|?]"+l+"=)","g");s.route=s.route.replace(c,"");var c=new RegExp("([&|?]"+l+"=:"+l+")","g");i.selectorData[s.route_group].items[s.route_id].route=i.selectorData[s.route_group].items[s.route_id].route.replace(c,"")}m&&(s.route=s.route.replace(/([\+\，\！\？]|[\u4E00-\uFA29]|[\uE7C7-\uE7F3])/g,function(t){return encodeURIComponent(t)}).replace(/\s+/g,""))}i.settings.callback&&"function"==typeof i.settings.callback&&i.settings.callback(s),setTimeout(function(){e.prototype.hide()},0),$(".s_submit").unbind("click",a)}var i=this,s="",o="",l="",n=t.utmContent;n&&(n.business.map(function(t){s+='<option value="'+t+'">'+t+"</option>"}),n.activities.map(function(t){o+='<option value="'+t+'">'+t+"</option>"}),n.tags.map(function(t){l+='<option value="'+t+'">'+t+"</option>"}));var r='<div id="select_approute" tabindex="-1" role="dialog" data-width="760" data-hasfoot="false" data-backdrop="static" class="approute-picker sui-modal hide fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-body"><button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×</button><div class="s_title"><p>选择组件</p></div><div class="s_route"><div class="s_route_list"><div class="group-wrap"><div class="group-title">常用:</div><ul><li class="route-item" route-id="0" route-group="0">领优惠券</li><li class="route-item s_select" route-id="1" route-group="0">插入视频</li></ul></div></div></div><div class="s_param"><ul><li><p data-name="poster">封面链接:</p><input type="text" value=""></li><li><p data-name="src">视频链接:</p><input type="text" value=""></li></ul></div><div class="s_button"><button class="s_submit sui-btn btn-xlarge btn-primary">确认</button><button class="s_close sui-btn btn-xlarge">取消</button></div></div></div></div></div>',c='<div id="utm_content" tabindex="-1" role="dialog" data-hasfoot="false" class="sui-modal hide fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×</button><h4 id="myModalLabel" class="modal-title">设置UTM追踪统计信息</h4></div><div class="modal-body">        <div style="margin: 10px 0">        <div style="display: inline-block;width: 70px;text-align: right">标题:</div><input type="text" style="width: 300px;height: 30px;margin-left: 5px;padding-left:5px;" class="utm-title">        </div>        <div style="margin: 10px 0">        <label for="id_label_single">        <div style="display: inline-block;width: 70px;text-align: right">业务方:</div>        <select class="js-example-basic-single js-states form-control business" id="id_label_single">'+s+'            </select>            </label>            </div>            <div style="margin: 10px 0"><label for="id_label_multiple">            <div style="display: inline-block;width: 70px;text-align: right">系列活动名:</div>        <select class="js-example-basic-multiple js-states form-control activity" id="id_label_multiple" multiple="multiple">'+o+'            </select>            </label></div>            <div style="margin: 10px 0"><label for="id_label_multiple">            <div style="display: inline-block;width: 70px;text-align: right">标签:</div>        <select class="js-example-basic-multiple js-states form-control tags" id="id_label_multiple" multiple="multiple">'+l+'            </select>            </label></div>            </div><div class="modal-footer"><button type="button" data-ok="modal" class="sui-btn btn-primary btn-large utm-btn">提交</button></div></div></div></div>';if(this.selectorData=t.selectorData,t.selectorCommonParams&&(i.selectorCommonParams=t.selectorCommonParams,i.commonParams={},$.each(i.selectorCommonParams,function(t,e){$.each(e,function(t,e){i.commonParams[t]=e})})),this.settings=t,console.log(u),0==$("body #select_approute").length){$("body").append(r),$("body").append(c),$("body").append("<style>.select2-container--default .select2-selection--single{width:300px}.select2-container--default .select2-selection--multiple{width:300px}</style>");var u={},p=this.settings.app_route?this.settings.app_route.split("?")[1]:"",d=p&&p.split("&");d&&(d.map(function(t){u[t.split("=")[0]]=t.split("=")[1]}),$(".utm-title").val(decodeURIComponent(u.content_title)),$(".business").val(decodeURIComponent(u.content_business)),$(".activity").val(decodeURIComponent(u.content_act).split(",")),$(".tags").val(decodeURIComponent(u.content_tags).split(","))),$("body").on("click",".s_route_list li",function(t){i.settings.app_route="",i.binding_data($(this),!1)})}var m=t.checkRoute||!1;$(".s_submit").unbind("click").bind("click",a),$("body").on("click",".s_close",function(){$(".s_submit").unbind("click",a),i.hide()});for(var r="",v=0,_=this.selectorData.length;v<_;v++){var g="";for(var b in this.selectorData[v].items)this.selectorData[v].items[b]&&(g+="<li class='route-item' route-id="+b+" route-group="+v+">"+this.selectorData[v].items[b].name+"</li>");r+='<div class="group-wrap"><div class="group-title">'+this.selectorData[v].group+":</div><ul>"+g+"</ul></div>"}$(".s_route_list").html(r),this.binding_data=function(t,e){if($(".s_route_list li").removeClass("s_select"),""!=this.settings.app_route){var a=null;this.settings.notEncode||(this.settings.app_route=this.settings.app_route.replace(/(&|\?)content_title=(.*)&content_business=(.*)&content_act=(.*)&content_tags=(.*)/,""));for(var s=0,o=this.selectorData.length;s<o;s++){for(var l in this.selectorData[s].items)if(this.is_match(this.selectorData[s].items[l],this.settings.app_route)){a=$("[route-group="+s+"][route-id="+l+"]"),this.settings.params=this.match_app_route(this.selectorData[s].items[l],this.settings.app_route);break}if(a){t=a;break}}}t.addClass("s_select");var n,r=t.attr("route-id"),c=t.attr("route-group");r&&(n=i.selectorData[c].items[r].params,i.commonParams&&(n=n?n:{},i.selectorData[c].items[r].params||(i.selectorData[c].items[r].params={}),$.extend(n,i.commonParams),$.extend(i.selectorData[c].items[r].params,i.commonParams),$.each(i.commonParams,function(t,e){var a=i.selectorData[c].items[r].route.indexOf("?")==-1?"?":"&";i.selectorData[c].items[r].route.indexOf(t)==-1&&(i.selectorData[c].items[r].route+=a+t+"=:"+t)})));var u="";if(n){for(var s in n)if("object"==typeof n[s]){var p="";switch(n[s].type){case"image":p="param-image-picker";break;case"date":p="param-date";break;case"datetime":p="param-datetime";break;case"coupon":p="param-coupon";break;case"app_route":p="param-app-route"}console.log(n[s]);var d=0;n[s].can_null&&(d=1),u+='<li><p data-name="'+s+'">'+n[s].name+':</p><input type="text" '+p+' value="" data-can-null="'+d+'"/></li>'}else u+='<li><p data-name="'+s+'">'+n[s]+':</p><input type="text"  value="" /></li>';$(".s_param ul").html(u),$(".s_param ul [param-image-picker]").imagePicker({el:"self",mode:"replace",format:"shortTag",objType:"component",objId:0}),$(".s_param ul [param-datetime]").datetimepicker(),$(".s_param ul [param-app-route]").appRoutePicker()}else $(".s_param ul").html("无参数~~");if(this.settings.params&&e)for(var s in this.settings.params)$(".s_param ul>li p[data-name="+s+"]").next().val(this.settings.params[s])}};return e.prototype={constructor:e,init:function(t){$(this);this.binding_data($('[route-id="'+this.settings.id+'"]'),!0),this.show()},destroy:function(){$(".s_route_list li").unbind("click"),$(".s_close").unbind("click"),$(".s_submit").unbind("click")},show:function(t){$("#select_approute").modal("show")},hide:function(){$(".s_route_list li").removeClass("s_select"),$(".s_param ul").html("无参数~~"),$("#select_approute").modal("hide")},is_match:function(t,e){var a=t.route.replace(/(\?|\/)/g,"\\$1");for(var i in t.params)a=a.replace(":"+i,"(.+)");var s=new RegExp("^"+a+"$");return s.test(e)},match_app_route:function(t,e){var e=decodeURI(e),a=t.route.replace(/(\?|\/)/g,"\\$1");console.log(t.route,a);for(var i in t.params)a=a.replace(":"+i,"(.+)");var s=new RegExp(a),o=e.match(s),l={},n=1;for(var i in t.params)l[i]=o[n++];return l}},e});